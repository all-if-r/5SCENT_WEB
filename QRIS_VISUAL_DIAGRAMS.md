# ğŸ“Š QRIS Payment Flow - Visual Diagrams

---

## 1ï¸âƒ£ Complete Payment Flow (Before & After)

### BEFORE FIX âŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Checkout Page  â”‚
â”‚  (Next.js)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ User clicks "Confirm Payment"
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create Order       â”‚ â† Succeeds âœ…
    â”‚ (POST /orders)     â”‚
    â”‚ Returns: order_id  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ order_id = 57
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create QRIS Payment    â”‚ â† Fails âŒ
    â”‚ (POST /payments/qris)  â”‚
    â”‚ Send: { order_id: 57 } â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ itemDetails sum â‰  gross_amount
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Midtrans API Call           â”‚
    â”‚ Returns 400 Error           â”‚
    â”‚ "gross_amount mismatch"     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Error Toast Shown    â”‚
    â”‚ âŒ Payment Failed    â”‚
    â”‚                      â”‚
    â”‚ No QR displayed      â”‚
    â”‚ No redirect          â”‚
    â”‚ No qris_transaction  â”‚
    â”‚ record created       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AFTER FIX âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Checkout Page  â”‚
â”‚  (Next.js)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ User clicks "Confirm Payment"
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create Order       â”‚ â† Succeeds âœ…
    â”‚ (POST /orders)     â”‚
    â”‚ Returns: order_id  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ order_id = 57
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create QRIS Payment          â”‚ â† Succeeds âœ…
    â”‚ (POST /payments/qris)        â”‚
    â”‚ Send: { order_id: 57 }       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ Load order.details
             â”œâ”€ Build itemDetails array
             â”œâ”€ Calculate itemsTotal âœ… NEW
             â”œâ”€ Get grossAmount
             â”‚
             â”œâ”€ VALIDATE âœ… NEW
             â”‚  â”œâ”€ itemsTotal == 315,000
             â”‚  â”œâ”€ grossAmount == 315,000
             â”‚  â””â”€ MATCH? âœ…
             â”‚
             â””â”€ Send to Midtrans âœ…
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Midtrans API Call            â”‚
    â”‚ Returns 200 OK               â”‚
    â”‚ âœ… QR code generated         â”‚
    â”‚ âœ… transaction_id assigned   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ response.qr_url = "https://..."
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Save qris_transactions       â”‚
    â”‚ âœ… Record created            â”‚
    â”‚ âœ… QR URL stored             â”‚
    â”‚ âœ… Status: pending           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ response sent to frontend
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Frontend Success             â”‚
    â”‚ âœ… Success toast shown       â”‚
    â”‚ âœ… Redirect to:              â”‚
    â”‚    /orders/57/qris           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ QR Page (Next.js)            â”‚
    â”‚ âœ… QR code displayed         â”‚
    â”‚ âœ… Ready for scan            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2ï¸âƒ£ Item Details Validation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order Total: 315,000            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                             â”‚
             â†“                             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Load items from  â”‚         â”‚ Calculate total  â”‚
    â”‚ order.details    â”‚         â”‚ price Ã— qty      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                           â”‚
             â”œâ”€ Item 1: Shirt           â”‚
             â”‚  price: 100,000          â”œâ”€ Sum: 100k
             â”‚  qty: 1                  â”‚
             â”‚                          â”‚
             â”œâ”€ Item 2: Pants           â”œâ”€ Sum: 157.5k
             â”‚  price: 157,500          â”‚
             â”‚  qty: 1                  â”‚
             â”‚                          â”‚
             â””â”€ Item 3: Shoes           â””â”€ Sum: 57.5k
                price: 57,500
                qty: 1

             Items Total: 315,000
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ VALIDATE                      â”‚
    â”‚ items_total == gross_amount?  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚             â”‚          â”‚          â”‚
         MATCH         MISMATCH    EMPTY    NEGATIVE
             â”‚             â”‚          â”‚          â”‚
             â†“             â†“          â†“          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Use    â”‚  â”‚ Add      â”‚  â”‚Createâ”‚  â”‚Add     â”‚
        â”‚items   â”‚  â”‚ADJUST    â”‚  â”‚ORDER â”‚  â”‚NEGATIVEâ”‚
        â”‚as-is   â”‚  â”‚item      â”‚  â”‚item  â”‚  â”‚ADJUST  â”‚
        â”‚        â”‚  â”‚          â”‚  â”‚      â”‚  â”‚        â”‚
        â”‚âœ…315k  â”‚  â”‚315k +    â”‚  â”‚315k  â”‚  â”‚315k +  â”‚
        â”‚        â”‚  â”‚adjust    â”‚  â”‚1     â”‚  â”‚adjust  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚= 315k âœ… â”‚  â”‚= 315kâ”‚  â”‚= 315k  â”‚
                    â”‚          â”‚  â”‚âœ…    â”‚  â”‚âœ…      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚          â”‚          â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Send to Midtrans            â”‚
            â”‚ item_details validated âœ…   â”‚
            â”‚ sum = gross_amount âœ…       â”‚
            â”‚ Midtrans accepts âœ…         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3ï¸âƒ£ State Transitions

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ORDER CREATED      â”‚
                    â”‚  status: Pending    â”‚
                    â”‚  order_id: 57       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                      checkout form filled
                    "Confirm Payment" clicked
                               â”‚
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ PAYMENT INITIATED    â”‚
                    â”‚ post /payments/qris  â”‚
                    â”‚                      â”‚
                    â”‚ âœ… Order exists      â”‚
                    â”‚ âœ… Items found       â”‚
                    â”‚ âœ… Totals match      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ QRIS_TRANSACTION     â”‚
                    â”‚ CREATED              â”‚
                    â”‚                      â”‚
                    â”‚ qris_transaction_id: â”‚
                    â”‚    15               â”‚
                    â”‚ status: pending      â”‚
                    â”‚ qr_url: <URL>        â”‚
                    â”‚ midtrans_order_id: âœ…
                    â”‚ midtrans_trans_id: âœ…
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    user scans QR code
                    payment processed
                               â”‚
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ WEBHOOK RECEIVED     â”‚
                    â”‚ settlement status    â”‚
                    â”‚ POST /midtrans/notif â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚                 â”‚            â”‚
                               â†“                 â†“            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ SETTLEMENT       â”‚ â”‚ EXPIRY      â”‚ â”‚ DENIED  â”‚
                    â”‚                  â”‚ â”‚             â”‚ â”‚         â”‚
                    â”‚ qris status:     â”‚ â”‚qris status: â”‚ â”‚ status: â”‚
                    â”‚ settlement       â”‚ â”‚expire       â”‚ â”‚ deny    â”‚
                    â”‚                  â”‚ â”‚             â”‚ â”‚         â”‚
                    â”‚ order status:    â”‚ â”‚order:       â”‚ â”‚ order:  â”‚
                    â”‚ Packaging        â”‚ â”‚Cancelled    â”‚ â”‚Cancelledâ”‚
                    â”‚                  â”‚ â”‚             â”‚ â”‚         â”‚
                    â”‚ payment status:  â”‚ â”‚payment:     â”‚ â”‚ payment:â”‚
                    â”‚ success          â”‚ â”‚failed       â”‚ â”‚ failed  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚                â”‚             â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ PAYMENT COMPLETE          â”‚
                        â”‚ Order fulfillment begins  â”‚
                        â”‚ or refund issued          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4ï¸âƒ£ Data Models & Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USERS                        â”‚
â”‚                              â”‚
â”‚ user_id (PK)                 â”‚
â”‚ name                         â”‚
â”‚ email                        â”‚
â”‚ phone                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ 1:Many
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORDERS                       â”‚
â”‚                              â”‚
â”‚ order_id (PK)                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id (FK)                 â”‚              â”‚
â”‚ status: Pending              â”‚              â”‚
â”‚ total_price: 315,000         â”‚              â”‚
â”‚ payment_method: QRIS         â”‚              â”‚
â”‚ created_at                   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
             â”‚                                â”‚
             â”œâ”€â”€â”€â”€ 1:Many â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
             â”‚                      â”‚         â”‚
             â†“                      â†“         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ORDER_DETAILS      â”‚  â”‚ QRIS_TRANSACTIONS    â”‚
    â”‚                    â”‚  â”‚ (NEW TABLE)          â”‚
    â”‚ order_detail_id    â”‚  â”‚                      â”‚
    â”‚ order_id (FK)      â”‚  â”‚ qris_transaction_id  â”‚
    â”‚ product_id (FK)    â”‚  â”‚ order_id (FK)    â—„â”€â”€â”¤
    â”‚ price: 100,000     â”‚  â”‚ status: pending      â”‚
    â”‚ quantity: 1        â”‚  â”‚ qr_url               â”‚
    â”‚ size: M            â”‚  â”‚ midtrans_order_id    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ midtrans_trans_id    â”‚
             â”‚              â”‚ expired_at           â”‚
             â”‚              â”‚ raw_notification     â”‚
             â”‚              â”‚ created_at           â”‚
             â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â””â”€â”€ 1:Many
                   â”‚
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ PRODUCTS             â”‚
        â”‚                      â”‚
        â”‚ product_id (PK)      â”‚
        â”‚ name: Shirt          â”‚
        â”‚ price: 100,000       â”‚
        â”‚ stock: 50            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


KEY RELATIONSHIP:
Order (1) â”€â”€â†’ (Many) OrderDetails
Order (1) â”€â”€â†’ (1) QrisTransaction
```

---

## 5ï¸âƒ£ Request/Response Flow

### REQUEST (Frontend â†’ Backend)

```
POST /api/payments/qris HTTP/1.1
Host: localhost:8000
Content-Type: application/json
Authorization: Bearer {token}

{
  "order_id": 57
}

Size: ~50 bytes
Time: 1-2 seconds
```

### PROCESSING (Backend â†’ Midtrans)

```
Midtrans Request:
POST /v2/charge HTTP/1.1
Host: api.sandbox.midtrans.com
Authorization: Basic {base64(server_key:)}
Content-Type: application/json

{
  "payment_type": "qris",
  "transaction_details": {
    "order_id": "ORDER-57-1765471100",
    "gross_amount": 315000
  },
  "customer_details": {...},
  "item_details": [
    {
      "id": "1",
      "price": 100000,
      "quantity": 1,
      "name": "Shirt (M)"
    },
    {
      "id": "2",
      "price": 157500,
      "quantity": 1,
      "name": "Pants (L)"
    },
    {
      "id": "ADJUSTMENT",
      "price": 57500,
      "quantity": 1,
      "name": "Adjustment"
    }
  ],
  "qris": {
    "acquirer": "gopay"
  },
  "custom_expiry": {
    "order_time": "2025-12-11 23:45:00",
    "expiry_duration": 5,
    "unit": "minute"
  }
}

Size: ~2KB
Time: 500-1000ms
```

### RESPONSE (Backend â†’ Frontend)

```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "success": true,
  "order_id": 57,
  "qris_transaction_id": 19,
  "qris": {
    "qr_url": "https://api.sandbox.midtrans.com/v2/qris/...",
    "expired_at": "2025-12-11T23:50:00+07:00",
    "status": "pending",
    "midtrans_order_id": "ORDER-57-1765471100",
    "midtrans_transaction_id": "8d182248-9b1d-4fb5-..."
  }
}

Size: ~500 bytes
Time: Instant (already received)
```

---

## 6ï¸âƒ£ Error Handling Tree

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ POST /payments/ â”‚
                        â”‚      qris       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Validate Request   â”‚
                        â”‚ order_id exists?   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                â”‚
                    YES (Valid)       NO (Invalid)
                         â”‚                â”‚
                         â†“                â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Load   â”‚      â”‚ Return   â”‚
                    â”‚ Order  â”‚      â”‚ 404      â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜      â”‚ Not Foundâ”‚
                         â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Build Payload  â”‚
                    â”‚ â€¢ itemDetails  â”‚
                    â”‚ â€¢ gross_amount â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ VALIDATE âœ… (NEW)  â”‚
                    â”‚ items_sum ==       â”‚
                    â”‚ gross_amount?      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                  NO (Mismatch)      YES (Match)
                    â”‚                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ADD ADJUSTMENT   â”‚
                    â”‚ item if needed âœ…â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Call Midtrans API  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚
                 HTTP 200         HTTP 400+
                    â”‚                 â”‚
                    â†“                 â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Extract QR   â”‚    â”‚ Log error    â”‚
            â”‚ Save to DB   â”‚    â”‚ Return error â”‚
            â”‚ Return JSON  â”‚    â”‚ response     â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Frontend:    â”‚
            â”‚ Display QR   â”‚
            â”‚ or Error     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary Legend

```
âœ…  = Working / Success
âŒ  = Broken / Failure
ğŸ”„  = In Progress / Processing
ğŸ“Š  = Data / Database
ğŸ’¾  = Storage
ğŸŒ  = External / API
âš¡  = Performance
ğŸ”§  = Configuration
ğŸ“  = Logging
```

---

**Updated:** December 11, 2025  
**Version:** 1.0 - Complete Fix

